name: ðŸ§¬ Integrated Trac-PharmacoNet Drug Discovery Pipeline

on:
  workflow_dispatch:
    inputs:
      input_chemicals:
        description: 'Input chemicals CSV filename (in input/ directory)'
        required: true
        default: 'input_chemicals.csv'
      num_targets_per_chemical:
        description: 'Number of top PDB targets per chemical'
        required: false
        default: '10'
        type: choice
        options:
          - '5'
          - '10'
          - '15'
          - '20'
      enable_cuda:
        description: 'Enable CUDA acceleration for PharmacoNet'
        required: false
        default: false
        type: boolean

jobs:
  # ============================================================================
  # STAGE 1: TRAC PDB LIGAND SCREENING
  # ============================================================================
  trac-screening:
    name: ðŸŽ¯ Stage 1 - Trac PDB Screening
    runs-on: ubuntu-latest
    
    outputs:
      screening-completed: ${{ steps.screening.outputs.completed }}
      total-pdbs: ${{ steps.screening.outputs.total_pdbs }}
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
      
      - name: ðŸ Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          # Removed cache: 'pip' to avoid requirements.txt dependency
      
      - name: ðŸ“¦ Install Trac Dependencies
        run: |
          pip install --upgrade pip
          pip install rdkit pandas numpy requests tqdm
      
      - name: ðŸ” Verify Required Files
        run: |
          echo "ðŸ“‚ Checking for required files..."
          ls -lh pdb_ligands.csv || echo "âš ï¸  WARNING: pdb_ligands.csv not found!"
          ls -lh final_optimized_workflow.py || echo "âš ï¸  WARNING: final_optimized_workflow.py not found!"
          ls -lh input/${{ github.event.inputs.input_chemicals }} || echo "âš ï¸  WARNING: Input file not found!"
      
      - name: ðŸ” Run Trac PDB Ligand Screening
        id: screening
        run: |
          echo "ðŸš€ Starting Trac PDB Screening..."
          python scripts/final_optimized_workflow.py \
            --input input/${{ github.event.inputs.input_chemicals }} \
            --output output/trac_screening_results.txt \
            --top_n ${{ github.event.inputs.num_targets_per_chemical }}
          
          # Count total PDBs extracted
          TOTAL_PDBS=$(grep -c "^PDB_ID" output/trac_screening_results.txt || echo "0")
          echo "total_pdbs=$TOTAL_PDBS" >> $GITHUB_OUTPUT
          echo "completed=true" >> $GITHUB_OUTPUT
          echo "âœ… Screening completed! Found $TOTAL_PDBS PDB targets"
      
      - name: ðŸ“Š Upload Trac Screening Results
        uses: actions/upload-artifact@v4
        with:
          name: trac-screening-results
          path: |
            output/trac_screening_results.txt
            output/ssc_screening_results.csv
          retention-days: 30

  # ============================================================================
  # STAGE 2: EXTRACT PDB IDs FOR PHARMACONET
  # ============================================================================
  extract-pdbs:
    name: ðŸ“‹ Stage 2 - Extract Top PDB Targets
    runs-on: ubuntu-latest
    needs: trac-screening
    
    outputs:
      pdb-list: ${{ steps.extract.outputs.pdb_list }}
      total-unique-pdbs: ${{ steps.extract.outputs.total_unique }}
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
      
      - name: ðŸ“¥ Download Trac Results
        uses: actions/download-artifact@v4
        with:
          name: trac-screening-results
          path: output/
      
      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: ðŸ” Extract PDB IDs
        id: extract
        run: |
          python scripts/extract_top_pdbs.py \
            --input output/trac_screening_results.txt \
            --output pharmaconet_input/pdb_list.txt \
            --top_n ${{ github.event.inputs.num_targets_per_chemical }}
          
          # Get unique PDB count
          UNIQUE_PDBS=$(sort pharmaconet_input/pdb_list.txt | uniq | wc -l)
          echo "total_unique=$UNIQUE_PDBS" >> $GITHUB_OUTPUT
          
          # Create comma-separated list for matrix
          PDB_LIST=$(cat pharmaconet_input/pdb_list.txt | tr '\n' ',' | sed 's/,$//')
          echo "pdb_list=$PDB_LIST" >> $GITHUB_OUTPUT
          
          echo "âœ… Extracted $UNIQUE_PDBS unique PDB targets"
      
      - name: ðŸ“Š Upload PDB List
        uses: actions/upload-artifact@v4
        with:
          name: pdb-target-list
          path: pharmaconet_input/pdb_list.txt
          retention-days: 30

  # ============================================================================
  # STAGE 3: PHARMACONET PHARMACOPHORE MODELING
  # ============================================================================
  pharmaconet-modeling:
    name: ðŸ”¬ Stage 3 - PharmacoNet Modeling
    runs-on: ubuntu-latest
    needs: extract-pdbs
    
    strategy:
      max-parallel: 5
      fail-fast: false
      matrix:
        batch: [1, 2, 3, 4, 5, 6, 7, 8]
    
    steps:
      - name: ðŸ“¥ Checkout PharmacoNet Repository
        uses: actions/checkout@v4
        with:
          repository: sakeermr/Tracmypdb_pharmaconet_new
          path: pharmaconet
      
      - name: ðŸ“¥ Download PDB List
        uses: actions/download-artifact@v4
        with:
          name: pdb-target-list
          path: input/
      
      - name: ðŸ Setup Conda Environment
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-update-conda: true
          python-version: '3.11'
          channels: conda-forge,defaults
          channel-priority: strict
      
      - name: ðŸ“¦ Install PharmacoNet
        shell: bash -el {0}
        run: |
          cd pharmaconet
          conda install -y pymol-open-source -c conda-forge
          pip install torch rdkit biopython omegaconf tqdm numba molvoxel
          pip install .
      
      - name: ðŸ”¬ Run Batch Pharmacophore Modeling
        shell: bash -el {0}
        run: |
          cd pharmaconet
          python scripts/batch_modeling_parallel.py \
            --pdb_list ../input/pdb_list.txt \
            --batch_num ${{ matrix.batch }} \
            --total_batches 8 \
            --output_dir ../pharmacophore_models/ \
            --log_dir ../logs/modeling/ \
            ${{ github.event.inputs.enable_cuda && '--cuda' || '' }}
      
      - name: ðŸ“Š Upload Pharmacophore Models (Batch ${{ matrix.batch }})
        uses: actions/upload-artifact@v4
        with:
          name: pharmacophore-models-batch-${{ matrix.batch }}
          path: pharmacophore_models/
          retention-days: 30
      
      - name: ðŸ“ Upload Modeling Logs (Batch ${{ matrix.batch }})
        uses: actions/upload-artifact@v4
        with:
          name: modeling-logs-batch-${{ matrix.batch }}
          path: logs/modeling/
          retention-days: 30

  # ============================================================================
  # STAGE 4: REVERSE SCREENING
  # ============================================================================
  reverse-screening:
    name: ðŸŽ¯ Stage 4 - Reverse Screening
    runs-on: ubuntu-latest
    needs: [trac-screening, pharmaconet-modeling]
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
      
      - name: ðŸ“¥ Download All Pharmacophore Models
        uses: actions/download-artifact@v4
        with:
          pattern: pharmacophore-models-batch-*
          path: pharmacophore_models/
          merge-multiple: true
      
      - name: ðŸ“¥ Download Trac Results
        uses: actions/download-artifact@v4
        with:
          name: trac-screening-results
          path: trac_results/
      
      - name: ðŸ Setup Conda
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-update-conda: true
          python-version: '3.11'
          channels: conda-forge,defaults
      
      - name: ðŸ“¦ Install Dependencies
        shell: bash -el {0}
        run: |
          conda install -y pymol-open-source -c conda-forge
          pip install torch rdkit pandas numpy
          pip install git+https://github.com/SeonghwanSeo/PharmacoNet.git
      
      - name: ðŸ”„ Run Reverse Screening
        shell: bash -el {0}
        run: |
          python scripts/reverse_screening_batch.py \
            --models_dir pharmacophore_models/ \
            --chemicals_file input/${{ github.event.inputs.input_chemicals }} \
            --output_dir screening_results/ \
            --log_dir logs/screening/ \
            --cpus 4
      
      - name: ðŸ“Š Generate Summary Report
        shell: bash -el {0}
        run: |
          python scripts/generate_summary_report.py \
            --trac_results trac_results/trac_screening_results.txt \
            --screening_results screening_results/ \
            --output final_report/
      
      - name: ðŸ“Š Upload Screening Results
        uses: actions/upload-artifact@v4
        with:
          name: screening-results-${{ github.run_number }}
          path: screening_results/
          retention-days: 30
      
      - name: ðŸ“ Upload Screening Logs
        uses: actions/upload-artifact@v4
        with:
          name: screening-logs-${{ github.run_number }}
          path: logs/screening/
          retention-days: 30
      
      - name: ðŸ“Š Upload Final Report
        uses: actions/upload-artifact@v4
        with:
          name: final-integrated-report-${{ github.run_number }}
          path: final_report/
          retention-days: 90

  # ============================================================================
  # STAGE 5: CONSOLIDATE AND SUMMARIZE
  # ============================================================================
  finalize:
    name: ðŸ“¦ Stage 5 - Finalize Results
    runs-on: ubuntu-latest
    needs: reverse-screening
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
      
      - name: ðŸ“¥ Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: all_results/
      
      - name: ðŸ“¦ Create Final Package
        run: |
          mkdir -p final_package/{logs,pharmacophore-models,screening-results}
          
          # Consolidate logs
          find all_results/modeling-logs-batch-* -type f -exec cp {} final_package/logs/ \; 2>/dev/null || true
          find all_results/screening-logs-* -type f -exec cp {} final_package/logs/ \; 2>/dev/null || true
          
          # Consolidate models
          find all_results/pharmacophore-models-batch-* -name "*.pm" -exec cp {} final_package/pharmacophore-models/ \; 2>/dev/null || true
          find all_results/pharmacophore-models-batch-* -name "*.pse" -exec cp {} final_package/pharmacophore-models/ \; 2>/dev/null || true
          
          # Consolidate screening results
          cp -r all_results/screening-results-*/. final_package/screening-results/ 2>/dev/null || true
          
          # Copy final report
          cp -r all_results/final-integrated-report-*/. final_package/ 2>/dev/null || true
          
          echo "âœ… Final package created successfully!"
          ls -R final_package/ || echo "Package structure created"
      
      - name: ðŸ“Š Upload Complete Pipeline Results
        uses: actions/upload-artifact@v4
        with:
          name: complete-pipeline-results-${{ github.run_number }}
          path: final_package/
          retention-days: 90
      
      - name: ðŸ“ Generate Workflow Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # ðŸ§¬ Integrated Drug Discovery Pipeline Complete!
          
          ## ðŸ“Š Pipeline Summary
          
          | Stage | Status | Details |
          |-------|--------|---------|
          | ðŸŽ¯ Trac Screening | âœ… Complete | Found ${{ needs.trac-screening.outputs.total-pdbs }} PDB targets |
          | ðŸ“‹ PDB Extraction | âœ… Complete | Extracted ${{ needs.extract-pdbs.outputs.total-unique-pdbs }} unique PDBs |
          | ðŸ”¬ Pharmacophore Modeling | âœ… Complete | Generated pharmacophore models |
          | ðŸŽ¯ Reverse Screening | âœ… Complete | Screened all chemicals against models |
          | ðŸ“¦ Finalization | âœ… Complete | Results packaged and ready |
          
          ## ðŸ“¦ Generated Artifacts
          
          - **complete-pipeline-results-${{ github.run_number }}** - Complete integrated results
          - **logs/** - All processing logs
          - **pharmacophore-models/** - All .pm and .pse files
          - **screening-results/** - Interaction predictions and scores
          
          ## ðŸ”— Download Results
          
          Click on the artifacts section above to download the complete results package.
          
          ---
          
          **Pipeline Run ID:** ${{ github.run_number }}  
          **Triggered by:** ${{ github.actor }}  
          **Date:** ${{ github.event.head_commit.timestamp }}
          EOF
