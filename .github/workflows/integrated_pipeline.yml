name: üß¨ Integrated Trac-PharmacoNet Drug Discovery Pipeline

on:
  workflow_dispatch:
    inputs:
      input_file:
        description: 'Input chemicals CSV path'
        required: false
        default: 'input/input_chemicals.csv'
      pdb_file:
        description: 'PDB ligands file path'
        required: false
        default: 'pdb_ligands.csv'
      output_prefix:
        description: 'Output file prefix'
        required: false
        default: 'ssc_screening_results'
      max_pdb:
        description: 'Maximum PDB records (0=all)'
        required: false
        default: '0'
      max_input:
        description: 'Maximum input chemicals (0=all)'
        required: false
        default: '0'
      debug_mode:
        description: 'Enable debug logging'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  run-pdb-screening:
    name: Run PDB Ligand Screening
    runs-on: ubuntu-latest

    env:
      INPUT_FILE: ${{ github.event.inputs.input_file || 'input/input_chemicals.csv' }}
      PDB_FILE: ${{ github.event.inputs.pdb_file || 'pdb_ligands.csv' }}
      OUTPUT_PREFIX: ${{ github.event.inputs.output_prefix || 'ssc_screening_results' }}
      MAX_PDB: ${{ github.event.inputs.max_pdb || '0' }}
      MAX_INPUT: ${{ github.event.inputs.max_input || '0' }}
      DEBUG_MODE: ${{ github.event.inputs.debug_mode || 'false' }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Validate input and PDB files
      run: |
        if [ ! -f "$INPUT_FILE" ]; then
          echo "::error:: ‚ùå Input chemicals file not found: $INPUT_FILE"
          exit 1
        fi
        if [ ! -f "$PDB_FILE" ]; then
          echo "::error:: ‚ùå PDB ligands file not found: $PDB_FILE"
          exit 1
        fi

    - name: Validate input CSV columns
      run: |
        header=$(head -n 1 "$INPUT_FILE" | tr '[:upper:]' '[:lower:]')
        for col in "plant" "chemical name" "molecular structure" "molecule category"; do
          if [[ ! "$header" =~ $col ]]; then
            echo "::error:: ‚ùå Input CSV missing required column: $col"
            exit 1
          fi
        done

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas numpy rdkit requests tqdm lxml openpyxl chardet matplotlib seaborn scipy

    - name: Make screening script executable
      run: chmod +x final_optimized_workflow.py || chmod +x scripts/final_optimized_workflow.py || true

    - name: Run SSC PDB ligand screening
      run: |
        echo "üß¨ Starting SSC PDB ligand screening..."
        mkdir -p output
        SCRIPT_PATH=""
        if [ -f "./final_optimized_workflow.py" ]; then
          SCRIPT_PATH="./final_optimized_workflow.py"
        elif [ -f "./scripts/final_optimized_workflow.py" ]; then
          SCRIPT_PATH="./scripts/final_optimized_workflow.py"
        else
          echo "::error:: 'final_optimized_workflow.py' not found!"
          exit 1
        fi

        python "$SCRIPT_PATH" \
          --input "$INPUT_FILE" \
          --pdb "$PDB_FILE" \
          --output "output/${OUTPUT_PREFIX}.csv" \
          --max-pdb "$MAX_PDB" \
          --max-input "$MAX_INPUT" \
          --verbose

    - name: Verifying SSC screening output files
      run: |
        echo "üîç Verifying SSC screening output files..."
        echo "üìÅ Files in output directory:"
        ls -lh output/
        echo "üîç Looking for files:"
        echo "  - CSV: output/${OUTPUT_PREFIX}_top5_targets.csv"
        echo "  - Report: output/${OUTPUT_PREFIX}_analysis_report.txt"
        echo "  - Detailed: output/${OUTPUT_PREFIX}_detailed_results.csv"
        if [ -f output/${OUTPUT_PREFIX}_top5_targets.csv ]; then
          echo "‚úÖ CSV file created: output/${OUTPUT_PREFIX}_top5_targets.csv"
          ls -lh output/${OUTPUT_PREFIX}_top5_targets.csv
          echo "First 5 lines of CSV:"
          head -n 5 output/${OUTPUT_PREFIX}_top5_targets.csv
        else
          echo "::warning:: CSV file not found!"
        fi
        if [ -f output/${OUTPUT_PREFIX}_analysis_report.txt ]; then
          echo "‚úÖ Analysis report created: output/${OUTPUT_PREFIX}_analysis_report.txt"
          ls -lh output/${OUTPUT_PREFIX}_analysis_report.txt
          echo "Report summary (first 20 lines):"
          head -n 20 output/${OUTPUT_PREFIX}_analysis_report.txt
        else
          echo "::warning:: Analysis report not found!"
        fi
        if [ -f output/${OUTPUT_PREFIX}_detailed_results.csv ]; then
          echo "‚úÖ Detailed results CSV found: output/${OUTPUT_PREFIX}_detailed_results.csv"
          ls -lh output/${OUTPUT_PREFIX}_detailed_results.csv
        else
          echo "::warning:: Detailed results CSV not found!"
        fi

    - name: Upload screening results as artifact
      uses: actions/upload-artifact@v4
      with:
        name: ssc-pdb-screening-results
        path: |
          output/${{ env.OUTPUT_PREFIX }}_top5_targets.csv
          output/${{ env.OUTPUT_PREFIX }}_analysis_report.txt
          output/${{ env.OUTPUT_PREFIX }}_detailed_results.csv
        retention-days: 30
