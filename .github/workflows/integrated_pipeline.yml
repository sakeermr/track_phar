name: üß¨ Integrated Trac-PharmacoNet Drug Discovery Pipeline

on:
  workflow_dispatch:
    inputs:
      input_chemicals:
        description: 'Input chemicals CSV filename (in input/ directory)'
        required: true
        default: 'input_chemicals.csv'
      num_targets_per_chemical:
        description: 'Number of top PDB targets per chemical'
        required: false
        default: '10'
        type: choice
        options: ['5', '10', '15', '20']
      enable_cuda:
        description: 'Enable CUDA acceleration for PharmacoNet'
        required: false
        default: false
        type: boolean

jobs:
  # ============================================================================
  # STAGE 1: TRAC PDB LIGAND SCREENING
  # ============================================================================
  trac-screening:
    name: üéØ Stage 1 - Trac PDB Screening
    runs-on: ubuntu-latest

    outputs:
      screening-completed: ${{ steps.screening.outputs.completed }}
      total-pdbs: ${{ steps.screening.outputs.total_pdbs }}

    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4

      - name: üêç Setup Python 3.9
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: üì¶ Install Trac Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy rdkit requests tqdm lxml openpyxl chardet matplotlib seaborn scipy

      - name: üîç Verify Required Files
        run: |
          ls -lh pdb_ligands.csv || echo "::warning:: pdb_ligands.csv not found!"
          ls -lh final_optimized_workflow.py || ls -lh scripts/final_optimized_workflow.py || echo "::warning:: final_optimized_workflow.py not found!"
          ls -lh input/${{ github.event.inputs.input_chemicals }} || echo "::warning:: Input chemicals file not found!"

      - name: üß¨ Run Trac PDB Ligand Screening
        id: screening
        run: |
          mkdir -p output
          if [ -f "./final_optimized_workflow.py" ]; then
            PY_SCRIPT="./final_optimized_workflow.py"
          elif [ -f "./scripts/final_optimized_workflow.py" ]; then
            PY_SCRIPT="./scripts/final_optimized_workflow.py"
          else
            echo "::error:: 'final_optimized_workflow.py' not found in root or scripts/"
            exit 1
          fi

          python "$PY_SCRIPT" \
            --input "input/${{ github.event.inputs.input_chemicals }}" \
            --pdb pdb_ligands.csv \
            --output "output/trac_screening_results.csv" \
            --max-pdb 0 --max-input 0 --verbose

          # Touch downstream artifact files if not produced
          [ -f output/trac_screening_results.csv ] || touch output/trac_screening_results.csv

          echo "total_pdbs=$(wc -l < output/trac_screening_results.csv)" >> $GITHUB_OUTPUT
          echo "completed=true" >> $GITHUB_OUTPUT

      - name: üìä Upload Trac Screening Results
        uses: actions/upload-artifact@v4
        with:
          name: trac-screening-results
          path: output/trac_screening_results.csv
          retention-days: 30

  # ============================================================================
  # STAGE 2: EXTRACT PDB IDs FOR PHARMACONET
  # ============================================================================
  extract-pdbs:
    name: üìã Stage 2 - Extract Top PDB Targets
    runs-on: ubuntu-latest
    needs: trac-screening

    outputs:
      pdb-list: ${{ steps.extract.outputs.pdb_list }}
      total-unique-pdbs: ${{ steps.extract.outputs.total_unique }}

    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4

      - name: üì• Download Trac Results
        uses: actions/download-artifact@v4
        with:
          name: trac-screening-results
          path: output/

      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: üîç Extract PDB IDs
        id: extract
        run: |
          mkdir -p pharmaconet_input
          PY_SCRIPT=""
          if [ -f "./extract_top_pdbs.py" ]; then
            PY_SCRIPT="./extract_top_pdbs.py"
          elif [ -f "./scripts/extract_top_pdbs.py" ]; then
            PY_SCRIPT="./scripts/extract_top_pdbs.py"
          else
            echo "::error:: 'extract_top_pdbs.py' not found in root or scripts/"
            exit 1
          fi

          python "$PY_SCRIPT" \
            --input output/trac_screening_results.csv \
            --output pharmaconet_input/pdb_list.txt \
            --top_n ${{ github.event.inputs.num_targets_per_chemical }}

          UNIQUE_PDBS=$(sort pharmaconet_input/pdb_list.txt | uniq | wc -l)
          echo "total_unique=$UNIQUE_PDBS" >> $GITHUB_OUTPUT
          PDB_LIST=$(cat pharmaconet_input/pdb_list.txt | tr '\n' ',' | sed 's/,$//')
          echo "pdb_list=$PDB_LIST" >> $GITHUB_OUTPUT

      - name: üìä Upload PDB List
        uses: actions/upload-artifact@v4
        with:
          name: pdb-target-list
          path: pharmaconet_input/pdb_list.txt
          retention-days: 30

  # ============================================================================
  # STAGE 3: PHARMACONET PHARMACOPHORE MODELING
  # ============================================================================
  pharmaconet-modeling:
    name: üî¨ Stage 3 - PharmacoNet Modeling
    runs-on: ubuntu-latest
    needs: extract-pdbs

    strategy:
      max-parallel: 8
      fail-fast: false
      matrix:
        batch: [1, 2, 3, 4, 5, 6, 7, 8]
    steps:
      - name: üì• Checkout PharmacoNet Repository
        uses: actions/checkout@v4
        with:
          repository: sakeermr/Tracmypdb_pharmaconet_new
          path: pharmaconet

      - name: üì• Download PDB List
        uses: actions/download-artifact@v4
        with:
          name: pdb-target-list
          path: input/

      - name: üêç Setup Conda Environment
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-update-conda: true
          python-version: '3.9'
          channels: conda-forge,defaults
          channel-priority: strict

      - name: üì¶ Install PharmacoNet
        shell: bash -el {0}
        run: |
          cd pharmaconet
          conda install -y pymol-open-source -c conda-forge
          pip install torch rdkit biopython omegaconf tqdm numba molvoxel
          pip install .

      - name: üî¨ Run Batch Pharmacophore Modeling
        shell: bash -el {0}
        run: |
          cd pharmaconet
          python scripts/batch_modeling_parallel.py \
            --pdb_list ../input/pdb_list.txt \
            --batch_num ${{ matrix.batch }} \
            --total_batches 8 \
            --output_dir ../pharmacophore_models/ \
            --log_dir ../logs/modeling/ \
            ${{ github.event.inputs.enable_cuda && '--cuda' || '' }}

      - name: üìä Upload Pharmacophore Models (Batch ${{ matrix.batch }})
        uses: actions/upload-artifact@v4
        with:
          name: pharmacophore-models-batch-${{ matrix.batch }}
          path: pharmacophore_models/
          retention-days: 30

      - name: üìù Upload Modeling Logs (Batch ${{ matrix.batch }})
        uses: actions/upload-artifact@v4
        with:
          name: modeling-logs-batch-${{ matrix.batch }}
          path: logs/modeling/
          retention-days: 30

  # ============================================================================
  # STAGE 4: REVERSE SCREENING
  # ============================================================================
  reverse-screening:
    name: üéØ Stage 4 - Reverse Screening
    runs-on: ubuntu-latest
    needs: [trac-screening, pharmaconet-modeling]

    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4

      - name: üì• Download All Pharmacophore Models
        uses: actions/download-artifact@v4
        with:
          pattern: pharmacophore-models-batch-*
          path: pharmacophore_models/
          merge-multiple: true

      - name: üì• Download Trac Results
        uses: actions/download-artifact@v4
        with:
          name: trac-screening-results
          path: trac_results/

      - name: üêç Setup Conda
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-update-conda: true
          python-version: '3.9'
          channels: conda-forge,defaults

      - name: üì¶ Install Dependencies
        shell: bash -el {0}
        run: |
          conda install -y pymol-open-source -c conda-forge
          pip install torch rdkit pandas numpy
          pip install git+https://github.com/SeonghwanSeo/PharmacoNet.git

      - name: üîÑ Run Reverse Screening
        shell: bash -el {0}
        run: |
          python scripts/reverse_screening_batch.py \
            --models_dir pharmacophore_models/ \
            --chemicals_file input/${{ github.event.inputs.input_chemicals }} \
            --output_dir screening_results/ \
            --log_dir logs/screening/ \
            --cpus 4

      - name: üìä Generate Summary Report
        shell: bash -el {0}
        run: |
          python scripts/generate_summary_report.py \
            --trac_results trac_results/trac_screening_results.csv \
            --screening_results screening_results/ \
            --output final_report/

      - name: üìä Upload Screening Results
        uses: actions/upload-artifact@v4
        with:
          name: screening-results-${{ github.run_number }}
          path: screening_results/
          retention-days: 30

      - name: üìù Upload Screening Logs
        uses: actions/upload-artifact@v4
        with:
          name: screening-logs-${{ github.run_number }}
          path: logs/screening/
          retention-days: 30

      - name: üìä Upload Final Report
        uses: actions/upload-artifact@v4
        with:
          name: final-integrated-report-${{ github.run_number }}
          path: final_report/
          retention-days: 90

  # ============================================================================
  # STAGE 5: CONSOLIDATE AND SUMMARIZE
  # ============================================================================
  finalize:
    name: üì¶ Stage 5 - Finalize Results
    runs-on: ubuntu-latest
    needs: reverse-screening

    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4

      - name: üì• Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: all_results/

      - name: üì¶ Create Final Package
        run: |
          mkdir -p final_package/{logs,pharmacophore-models,screening-results}

          # Consolidate logs
          find all_results/modeling-logs-batch-* -type f -exec cp {} final_package/logs/ \; 2>/dev/null || true
          find all_results/screening-logs-* -type f -exec cp {} final_package/logs/ \; 2>/dev/null || true

          # Consolidate models
          find all_results/pharmacophore-models-batch-* -name "*.pm" -exec cp {} final_package/pharmacophore-models/ \; 2>/dev/null || true
          find all_results/pharmacophore-models-batch-* -name "*.pse" -exec cp {} final_package/pharmacophore-models/ \; 2>/dev/null || true

          # Consolidate screening results
          cp -r all_results/screening-results-*/. final_package/screening-results/ 2>/dev/null || true

          # Copy final report
          cp -r all_results/final-integrated-report-*/. final_package/ 2>/dev/null || true

          echo "‚úÖ Final package created successfully!"
          ls -R final_package/ || echo "Package structure created"

      - name: üìä Upload Complete Pipeline Results
        uses: actions/upload-artifact@v4
        with:
          name: complete-pipeline-results-${{ github.run_number }}
          path: final_package/
          retention-days: 90

      - name: üìù Generate Workflow Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # üß¨ Integrated Drug Discovery Pipeline Complete!
          ## üìä Pipeline Summary
          | Stage | Status | Details |
          |-------|--------|---------|
          | üéØ Trac Screening | ‚úÖ Complete | Found ${{ needs.trac-screening.outputs.total-pdbs }} PDB targets |
          | üìã PDB Extraction | ‚úÖ Complete | Extracted ${{ needs.extract-pdbs.outputs.total-unique-pdbs }} unique PDBs |
          | üî¨ Pharmacophore Modeling | ‚úÖ Complete | Generated pharmacophore models |
          | üéØ Reverse Screening | ‚úÖ Complete | Screened all chemicals against models |
          | üì¶ Finalization | ‚úÖ Complete | Results packaged and ready |

          ## üì¶ Generated Artifacts
          - **complete-pipeline-results-${{ github.run_number }}** - Complete integrated results
          - **logs/** - All processing logs
          - **pharmacophore-models/** - All .pm and .pse files
          - **screening-results/** - Interaction predictions and scores

          ## üîó Download Results
          Click on the artifacts section above to download the complete results package.
          ---
          **Pipeline Run:** ${{ github.run_number }}  
          **Triggered by:** ${{ github.actor }}  
          EOF
