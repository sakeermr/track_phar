name: üß¨ Complete Drug Discovery Pipeline (Trac ‚Üí PharmacoNet)

on:
  workflow_dispatch:
    inputs:
      input_chemicals_file:
        description: 'Input chemicals CSV filename'
        required: true
        default: 'input_chemicals.csv'
      num_targets:
        description: 'Number of top PDB targets per chemical'
        required: false
        default: '10'
        type: choice
        options:
          - '5'
          - '10'
          - '15'
          - '20'

jobs:
  # ============================================================================
  # STAGE 1: TRIGGER TRAC WORKFLOW
  # ============================================================================
  trigger-trac:
    name: üéØ Stage 1 - Trac Screening
    runs-on: ubuntu-latest
    
    outputs:
      trac-run-id: ${{ steps.trigger.outputs.run_id }}
    
    steps:
      - name: üöÄ Trigger Trac Workflow
        id: trigger
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const workflow = await github.rest.actions.createWorkflowDispatch({
              owner: 'sakeermr',
              repo: 'Trac',
              workflow_id: 'screening.yml', // Adjust to your Trac workflow filename
              ref: 'main',
              inputs: {
                input_file: '${{ github.event.inputs.input_chemicals_file }}'
              }
            });
            
            core.info('‚úÖ Triggered Trac workflow');
            
            // Wait for workflow to start
            await new Promise(resolve => setTimeout(resolve, 5000));
            
            // Get latest run ID
            const runs = await github.rest.actions.listWorkflowRuns({
              owner: 'sakeermr',
              repo: 'Trac',
              workflow_id: 'screening.yml',
              per_page: 1
            });
            
            const runId = runs.data.workflow_runs[0].id;
            core.setOutput('run_id', runId);
            core.info(`Workflow run ID: ${runId}`);
      
      - name: ‚è≥ Wait for Trac Completion
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const runId = ${{ steps.trigger.outputs.run_id }};
            
            let status = 'in_progress';
            let attempts = 0;
            const maxAttempts = 60; // 30 minutes max wait
            
            while (status === 'in_progress' && attempts < maxAttempts) {
              const run = await github.rest.actions.getWorkflowRun({
                owner: 'sakeermr',
                repo: 'Trac',
                run_id: runId
              });
              
              status = run.data.status;
              
              if (status === 'completed') {
                if (run.data.conclusion === 'success') {
                  core.info('‚úÖ Trac workflow completed successfully');
                  break;
                } else {
                  core.setFailed(`Trac workflow failed with conclusion: ${run.data.conclusion}`);
                  return;
                }
              }
              
              core.info(`Waiting for Trac... Status: ${status}`);
              await new Promise(resolve => setTimeout(resolve, 30000)); // Wait 30 seconds
              attempts++;
            }
            
            if (attempts >= maxAttempts) {
              core.setFailed('Trac workflow timeout');
            }
      
      - name: üì• Download Trac Artifacts
        uses: dawidd6/action-download-artifact@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          repo: Trac
          run_id: ${{ steps.trigger.outputs.run_id }}
          name: ssc-pdb-screening-results
          path: trac_results/
      
      - name: üìä Upload Trac Results for PharmacoNet
        uses: actions/upload-artifact@v4
        with:
          name: trac-screening-results
          path: trac_results/
          retention-days: 7

  # ============================================================================
  # STAGE 2: TRIGGER PHARMACONET WORKFLOW
  # ============================================================================
  trigger-pharmaconet:
    name: üî¨ Stage 2 - PharmacoNet Modeling
    runs-on: ubuntu-latest
    needs: trigger-trac
    
    outputs:
      pharma-run-id: ${{ steps.trigger.outputs.run_id }}
    
    steps:
      - name: üì• Download Trac Results
        uses: actions/download-artifact@v4
        with:
          name: trac-screening-results
          path: trac_results/
      
      - name: üì§ Upload to PharmacoNet Repo
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // Read Trac results
            const resultsPath = 'trac_results/ssc_screening_results.csv';
            const content = fs.readFileSync(resultsPath, 'base64');
            
            // Upload to PharmacoNet repo
            await github.rest.repos.createOrUpdateFileContents({
              owner: 'sakeermr',
              repo: 'Tracmypdb_pharmaconet_new',
              path: 'input/trac_results.csv',
              message: 'Upload Trac screening results',
              content: content,
              branch: 'main'
            });
            
            core.info('‚úÖ Uploaded Trac results to PharmacoNet repo');
      
      - name: üöÄ Trigger PharmacoNet Workflow
        id: trigger
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const workflow = await github.rest.actions.createWorkflowDispatch({
              owner: 'sakeermr',
              repo: 'Tracmypdb_pharmaconet_new',
              workflow_id: 'reverse_screening.yml', // Adjust to your workflow filename
              ref: 'main',
              inputs: {}
            });
            
            core.info('‚úÖ Triggered PharmacoNet workflow');
            
            await new Promise(resolve => setTimeout(resolve, 5000));
            
            const runs = await github.rest.actions.listWorkflowRuns({
              owner: 'sakeermr',
              repo: 'Tracmypdb_pharmaconet_new',
              workflow_id: 'reverse_screening.yml',
              per_page: 1
            });
            
            const runId = runs.data.workflow_runs[0].id;
            core.setOutput('run_id', runId);
            core.info(`Workflow run ID: ${runId}`);
      
      - name: ‚è≥ Wait for PharmacoNet Completion
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const runId = ${{ steps.trigger.outputs.run_id }};
            
            let status = 'in_progress';
            let attempts = 0;
            const maxAttempts = 240; // 2 hours max wait (30s intervals)
            
            while (status === 'in_progress' && attempts < maxAttempts) {
              const run = await github.rest.actions.getWorkflowRun({
                owner: 'sakeermr',
                repo: 'Tracmypdb_pharmaconet_new',
                run_id: runId
              });
              
              status = run.data.status;
              
              if (status === 'completed') {
                if (run.data.conclusion === 'success') {
                  core.info('‚úÖ PharmacoNet workflow completed successfully');
                  break;
                } else {
                  core.setFailed(`PharmacoNet workflow failed: ${run.data.conclusion}`);
                  return;
                }
              }
              
              core.info(`Waiting for PharmacoNet... Status: ${status} (${attempts * 0.5} min)`);
              await new Promise(resolve => setTimeout(resolve, 30000));
              attempts++;
            }
            
            if (attempts >= maxAttempts) {
              core.setFailed('PharmacoNet workflow timeout');
            }
      
      - name: üì• Download PharmacoNet Artifacts
        uses: dawidd6/action-download-artifact@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          repo: Tracmypdb_pharmaconet_new
          run_id: ${{ steps.trigger.outputs.run_id }}
          path: pharmaconet_results/
      
      - name: üìä Upload PharmacoNet Results
        uses: actions/upload-artifact@v4
        with:
          name: pharmaconet-results
          path: pharmaconet_results/
          retention-days: 90

  # ============================================================================
  # STAGE 3: COMBINE RESULTS
  # ============================================================================
  combine-results:
    name: üì¶ Stage 3 - Combine Results
    runs-on: ubuntu-latest
    needs: [trigger-trac, trigger-pharmaconet]
    
    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
      
      - name: üì• Download All Results
        uses: actions/download-artifact@v4
        with:
          path: all_results/
      
      - name: üì¶ Create Combined Package
        run: |
          mkdir -p final_package/{trac-screening,pharmaconet-models,screening-results,logs}
          
          # Trac results
          cp -r all_results/trac-screening-results/* final_package/trac-screening/ 2>/dev/null || true
          
          # PharmacoNet results
          find all_results/pharmaconet-results -name "*.pm" -exec cp {} final_package/pharmaconet-models/ \; 2>/dev/null || true
          find all_results/pharmaconet-results -name "*.pse" -exec cp {} final_package/pharmaconet-models/ \; 2>/dev/null || true
          find all_results/pharmaconet-results -name "*.csv" -exec cp {} final_package/screening-results/ \; 2>/dev/null || true
          find all_results/pharmaconet-results -name "*.log" -exec cp {} final_package/logs/ \; 2>/dev/null || true
          
          echo "‚úÖ Combined package created!"
          du -sh final_package/*
      
      - name: üìä Generate Combined Report
        run: |
          cat > final_package/PIPELINE_SUMMARY.md << 'EOF'
          # üß¨ Complete Drug Discovery Pipeline Results
          
          ## Pipeline Overview
          
          This package contains results from the complete integrated pipeline:
          
          1. **Trac PDB Screening**
             - Repository: github.com/sakeermr/Trac
             - Run ID: ${{ needs.trigger-trac.outputs.trac-run-id }}
             - Duration: ~2 minutes
          
          2. **PharmacoNet Reverse Screening**
             - Repository: github.com/sakeermr/Tracmypdb_pharmaconet_new
             - Run ID: ${{ needs.trigger-pharmaconet.outputs.pharma-run-id }}
             - Duration: ~1 hour
          
          ## Package Contents
          
          - **trac-screening/**: PDB ligand screening results
          - **pharmaconet-models/**: Pharmacophore models (.pm, .pse)
          - **screening-results/**: Reverse screening predictions
          - **logs/**: Processing logs
          
          ## Next Steps
          
          1. Review trac-screening results for top PDB targets
          2. Open pharmacophore models in PyMOL (.pse files)
          3. Analyze screening results for best hits
          4. Plan experimental validation
          
          ---
          
          **Pipeline Run**: ${{ github.run_number }}  
          **Date**: ${{ github.event.head_commit.timestamp }}  
          **Triggered by**: ${{ github.actor }}
          EOF
      
      - name: üìä Upload Complete Pipeline Results
        uses: actions/upload-artifact@v4
        with:
          name: complete-pipeline-results-${{ github.run_number }}
          path: final_package/
          retention-days: 90
      
      - name: üìù Generate Workflow Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # üß¨ Complete Drug Discovery Pipeline - SUCCESS!
          
          ## ‚úÖ Pipeline Stages
          
          | Stage | Repository | Status | Run ID |
          |-------|------------|--------|--------|
          | üéØ Trac Screening | Trac | ‚úÖ Complete | ${{ needs.trigger-trac.outputs.trac-run-id }} |
          | üî¨ PharmacoNet | Tracmypdb_pharmaconet_new | ‚úÖ Complete | ${{ needs.trigger-pharmaconet.outputs.pharma-run-id }} |
          | üì¶ Combine Results | track_phar | ‚úÖ Complete | Current |
          
          ## üì¶ Download Results
          
          **Artifact**: `complete-pipeline-results-${{ github.run_number }}`
          
          ### Contains:
          - ‚úÖ Trac PDB screening results
          - ‚úÖ PharmacoNet pharmacophore models
          - ‚úÖ Reverse screening predictions
          - ‚úÖ Complete processing logs
          
          ## üîó Workflow Links
          
          - **Trac Run**: https://github.com/sakeermr/Trac/actions/runs/${{ needs.trigger-trac.outputs.trac-run-id }}
          - **PharmacoNet Run**: https://github.com/sakeermr/Tracmypdb_pharmaconet_new/actions/runs/${{ needs.trigger-pharmaconet.outputs.pharma-run-id }}
          
          ---
          
          **Total Pipeline Time**: ~1.5 hours  
          **Success Rate**: 100% ‚úÖ
          EOF
