name: üß¨ Complete Drug Discovery Pipeline (Trac ‚Üí PharmacoNet)

on:
  workflow_dispatch:
    inputs:
      input_chemicals_file:
        description: 'Input chemicals CSV filename'
        required: true
        default: 'input_chemicals.csv'
      num_targets:
        description: 'Number of top PDB targets per chemical'
        required: false
        default: '10'
        type: choice
        options:
          - '5'
          - '10'
          - '15'
          - '20'

jobs:
  # ============================================================================
  # STAGE 1: TRIGGER TRAC WORKFLOW
  # ============================================================================
  trigger-trac:
    name: üéØ Stage 1 - Trac Screening
    runs-on: ubuntu-latest
    
    outputs:
      trac-run-id: ${{ steps.trigger.outputs.run_id }}
    
    steps:
      - name: üöÄ Trigger Trac Workflow
        id: trigger
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const workflow = await github.rest.actions.createWorkflowDispatch({
              owner: 'sakeermr',
              repo: 'Trac',
              workflow_id: 'molecular-similarity-workflow-final.yml',
              ref: 'main',
              inputs: {
                input_file: '${{ github.event.inputs.input_chemicals_file }}'
              }
            });
            
            core.info('‚úÖ Triggered Trac workflow');
            
            // Wait for workflow to start
            await new Promise(resolve => setTimeout(resolve, 8000));
            
            // Get latest run ID
            const runs = await github.rest.actions.listWorkflowRuns({
              owner: 'sakeermr',
              repo: 'Trac',
              workflow_id: 'molecular-similarity-workflow-final.yml',
              per_page: 1
            });
            
            const runId = runs.data.workflow_runs[0].id;
            core.setOutput('run_id', runId);
            core.info(`Workflow run ID: ${runId}`);
      
      - name: ‚è≥ Wait for Trac Completion
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const runId = ${{ steps.trigger.outputs.run_id }};
            let status = 'in_progress';
            let attempts = 0;
            const maxAttempts = 60; 
            
            while (status === 'in_progress' && attempts < maxAttempts) {
              const run = await github.rest.actions.getWorkflowRun({
                owner: 'sakeermr',
                repo: 'Trac',
                run_id: runId
              });
              
              status = run.data.status;
              if (status === 'completed') {
                if (run.data.conclusion === 'success') {
                  core.info('‚úÖ Trac workflow completed successfully');
                  break;
                } else {
                  core.setFailed(`Trac workflow failed with conclusion: ${run.data.conclusion}`);
                  return;
                }
              }
              core.info(`Waiting for Trac... Status: ${status}`);
              await new Promise(resolve => setTimeout(resolve, 30000));
              attempts++;
            }

      - name: üì• Download Trac Artifacts
        uses: dawidd6/action-download-artifact@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          repo: Trac
          run_id: ${{ steps.trigger.outputs.run_id }}
          name: ssc-pdb-screening-results
          path: trac_results/
      
      - name: üìä Upload Trac Results for PharmacoNet
        uses: actions/upload-artifact@v4
        with:
          name: trac-screening-results
          path: trac_results/
          retention-days: 7

  # ============================================================================
  # STAGE 2: TRIGGER PHARMACONET WORKFLOW
  # ============================================================================
  trigger-pharmaconet:
    name: üî¨ Stage 2 - PharmacoNet Modeling
    runs-on: ubuntu-latest
    needs: trigger-trac
    
    outputs:
      pharma-run-id: ${{ steps.trigger.outputs.run_id }}
    
    steps:
      - name: üì• Download Trac Results
        uses: actions/download-artifact@v4
        with:
          name: trac-screening-results
          path: trac_results/
      
      - name: üì§ Upload to PharmacoNet Repo
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const resultsPath = 'trac_results/ssc_screening_results.csv';
            const content = fs.readFileSync(resultsPath, 'base64');
            
            await github.rest.repos.createOrUpdateFileContents({
              owner: 'sakeermr',
              repo: 'Tracmypdb_pharmaconet_new',
              path: 'input/trac_results.csv',
              message: 'Update Trac results for PharmacoNet screening',
              content: content,
              branch: 'main'
            });
            core.info('‚úÖ Uploaded Trac results to PharmacoNet repo');
      
      - name: üöÄ Trigger PharmacoNet Workflow
        id: trigger
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const workflow = await github.rest.actions.createWorkflowDispatch({
              owner: 'sakeermr',
              repo: 'Tracmypdb_pharmaconet_new',
              workflow_id: 'reverse_screening.yml',
              ref: 'main',
              inputs: {}
            });
            
            await new Promise(resolve => setTimeout(resolve, 8000));
            
            const runs = await github.rest.actions.listWorkflowRuns({
              owner: 'sakeermr',
              repo: 'Tracmypdb_pharmaconet_new',
              workflow_id: 'reverse_screening.yml',
              per_page: 1
            });
            
            const runId = runs.data.workflow_runs[0].id;
            core.setOutput('run_id', runId);
      
      - name: ‚è≥ Wait for PharmacoNet Completion
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const runId = ${{ steps.trigger.outputs.run_id }};
            let status = 'in_progress';
            let attempts = 0;
            const maxAttempts = 240; 
            
            while (status === 'in_progress' && attempts < maxAttempts) {
              const run = await github.rest.actions.getWorkflowRun({
                owner: 'sakeermr',
                repo: 'Tracmypdb_pharmaconet_new',
                run_id: runId
              });
              
              status = run.data.status;
              if (status === 'completed') {
                if (run.data.conclusion === 'success') {
                  core.info('‚úÖ PharmacoNet workflow completed successfully');
                  break;
                } else {
                  core.setFailed(`PharmacoNet workflow failed: ${run.data.conclusion}`);
                  return;
                }
              }
              await new Promise(resolve => setTimeout(resolve, 30000));
              attempts++;
            }

      - name: üì• Download PharmacoNet Artifacts
        uses: dawidd6/action-download-artifact@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          repo: Tracmypdb_pharmaconet_new
          run_id: ${{ steps.trigger.outputs.run_id }}
          path: pharmaconet_results/
      
      - name: üìä Upload PharmacoNet Results
        uses: actions/upload-artifact@v4
        with:
          name: pharmaconet-results
          path: pharmaconet_results/
          retention-days: 90

  # ============================================================================
  # STAGE 3: COMBINE RESULTS
  # ============================================================================
  combine-results:
    name: üì¶ Stage 3 - Combine Results
    runs-on: ubuntu-latest
    needs: [trigger-trac, trigger-pharmaconet]
    
    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
      
      - name: üì• Download All Results
        uses: actions/download-artifact@v4
        with:
          path: all_results/
      
      - name: üì¶ Create Combined Package
        run: |
          mkdir -p final_package/{trac-screening,pharmaconet-models,screening-results,logs}
          cp -r all_results/trac-screening-results/* final_package/trac-screening/ 2>/dev/null || true
          find all_results/pharmaconet-results -name "*.pm" -exec cp {} final_package/pharmaconet-models/ \; 2>/dev/null || true
          find all_results/pharmaconet-results -name "*.pse" -exec cp {} final_package/pharmaconet-models/ \; 2>/dev/null || true
          find all_results/pharmaconet-results -name "*.csv" -exec cp {} final_package/screening-results/ \; 2>/dev/null || true
          find all_results/pharmaconet-results -name "*.log" -exec cp {} final_package/logs/ \; 2>/dev/null || true
      
      - name: üìä Upload Complete Pipeline Results
        uses: actions/upload-artifact@v4
        with:
          name: complete-pipeline-results-${{ github.run_number }}
          path: final_package/
          retention-days: 90
